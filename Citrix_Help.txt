# Path to the machine list
$MachineList = "machines.txt"

# Output CSV
$OutputFile = "BluePrismVersions.csv"

# Prepare results array
$Results = @()

# Read machine names
$Machines = Get-Content -Path $MachineList

foreach ($Machine in $Machines) {
    Write-Host "Checking $Machine ..." -ForegroundColor Cyan

    try {
        # Query installed applications remotely via registry
        $BluePrism = Invoke-Command -ComputerName $Machine -ScriptBlock {
            $paths = @(
                "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\*",
                "HKLM:\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall\*"
            )

            foreach ($path in $paths) {
                Get-ItemProperty -Path $path -ErrorAction SilentlyContinue |
                    Where-Object { $_.DisplayName -like "*Blue Prism*" }
            }
        } -ErrorAction Stop

        if ($BluePrism) {
            foreach ($app in $BluePrism) {
                $Results += [PSCustomObject]@{
                    ComputerName = $Machine
                    Version      = $app.DisplayVersion
                }
            }
        }
        else {
            # No Blue Prism found
            $Results += [PSCustomObject]@{
                ComputerName = $Machine
                Version      = "Not Installed"
            }
        }
    }
    catch {
        # Machine unreachable or access denied
        $Results += [PSCustomObject]@{
            ComputerName = $Machine
            Version      = "Error: $($_.Exception.Message)"
        }
    }
}

# Export results to CSV
$Results | Export-Csv -Path $OutputFile -NoTypeInformation

Write-Host "Scan complete! Results saved to $OutputFile" -ForegroundColor Green
