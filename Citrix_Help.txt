# Uninstall-VSCode.ps1
# Removes Visual Studio Code from remote machines listed in machines.txt
# Cleans up both registry-based installs and leftover folders

$MachineList = Get-Content -Path ".\machines.txt"

# Define uninstall + cleanup actions
$ScriptBlock = {
    Write-Host "========== $env:COMPUTERNAME ==========" -ForegroundColor Cyan

    # 1️⃣ Try registry-based uninstalls (system-wide + per-user)
    $uninstallPaths = @(
        "HKLM:\Software\Microsoft\Windows\CurrentVersion\Uninstall\*",
        "HKLM:\Software\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall\*",
        "HKCU:\Software\Microsoft\Windows\CurrentVersion\Uninstall\*"
    )

    $vscodeEntries = foreach ($path in $uninstallPaths) {
        Get-ItemProperty -Path $path -ErrorAction SilentlyContinue |
        Where-Object { $_.DisplayName -like "Visual Studio Code*" }
    }

    if ($vscodeEntries) {
        foreach ($entry in $vscodeEntries) {
            $uninstallString = $entry.UninstallString
            if ($uninstallString) {
                Write-Host "Uninstalling VSCode using: $uninstallString"
                try {
                    Start-Process -FilePath "cmd.exe" -ArgumentList "/c `"$uninstallString /VERYSILENT /NORESTART`"" -Wait -ErrorAction Stop
                    Write-Host "VSCode uninstalled successfully." -ForegroundColor Green
                }
                catch {
                    Write-Warning "Failed to uninstall VSCode. Error: $_"
                }
            }
        }
    }
    else {
        Write-Host "No registry-based VSCode installations found."
    }

    # 2️⃣ Clean up user profile folders
    Write-Host "Cleaning up user AppData folders..."
    $userProfileDirs = Get-ChildItem -Path "C:\Users" -Directory -ErrorAction SilentlyContinue |
                       Where-Object { $_.Name -notin @('Public', 'Default', 'Default User', 'All Users') }

    foreach ($userDir in $userProfileDirs) {
        $vscodeAppPath = Join-Path $userDir.FullName "AppData\Local\Programs\Microsoft VS Code"
        $vscodeDataPath = Join-Path $userDir.FullName "AppData\Roaming\Code"
        $desktopShortcut = Join-Path $userDir.FullName "Desktop\Visual Studio Code.lnk"
        $startMenuPath = Join-Path $userDir.FullName "AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Visual Studio Code.lnk"

        # Remove leftover folders and shortcuts
        foreach ($path in @($vscodeAppPath, $vscodeDataPath, $desktopShortcut, $startMenuPath)) {
            if (Test-Path $path) {
                try {
                    Remove-Item -Path $path -Recurse -Force -ErrorAction Stop
                    Write-Host "Removed: $path"
                }
                catch {
                    Write-Warning "Failed to remove $path. Error: $_"
                }
            }
        }
    }

    # 3️⃣ Remove any remaining system-wide traces (Program Files)
    $systemPaths = @(
        "C:\Program Files\Microsoft VS Code",
        "C:\Program Files (x86)\Microsoft VS Code"
    )

    foreach ($sysPath in $systemPaths) {
        if (Test-Path $sysPath) {
            try {
                Remove-Item -Path $sysPath -Recurse -Force -ErrorAction Stop
                Write-Host "Removed: $sysPath"
            }
            catch {
                Write-Warning "Failed to remove $sysPath. Error: $_"
            }
        }
    }

    Write-Host "Cleanup complete on $env:COMPUTERNAME" -ForegroundColor Green
    Write-Host ""
}

# 4️⃣ Run the cleanup on each remote VM
foreach ($Machine in $MachineList) {
    Write-Host "Connecting to $Machine..." -ForegroundColor Yellow
    try {
        Invoke-Command -ComputerName $Machine -ScriptBlock $ScriptBlock -ErrorAction Stop
    }
    catch {
        Write-Warning "Failed to connect to $Machine: $_"
    }
}
