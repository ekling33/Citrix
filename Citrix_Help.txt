# Set-DamewareRegistry.ps1
# Applies DameWare registry settings to all machines listed in machines.txt

# Path to the list of VMs
$ComputerListFile = ".\machines.txt"

if (!(Test-Path $ComputerListFile)) {
    Write-Host "ERROR: machines.txt not found in script directory." -ForegroundColor Red
    exit
}

# Read computer names
$ComputerNames = Get-Content $ComputerListFile | Where-Object { $_.Trim() -ne "" }

if ($ComputerNames.Count -eq 0) {
    Write-Host "ERROR: machines.txt is empty." -ForegroundColor Red
    exit
}

# Registry path to apply
$RegPath = "HKLM:\SOFTWARE\DameWare Development\Mini Remote Control Service\Settings"

# Script that runs on the remote machine
$RemoteBlock = {
    param($RegPath)

    try {
        # Create path if missing
        if (-not (Test-Path $RegPath)) {
            New-Item -Path $RegPath -Force | Out-Null
        }

        # Set values
        Set-ItemProperty -Path $RegPath -Name "Notify On New Connection" -Value 0 -Type DWord -Force
        Set-ItemProperty -Path $RegPath -Name "Permission Required for non Admin Force View Only" -Value 1 -Type DWord -Force
        Set-ItemProperty -Path $RegPath -Name "Permission Required for non Admin" -Value 1 -Type DWord -Force
        Set-ItemProperty -Path $RegPath -Name "Permission Required for non Admin Disconnect If At Logon Desktop" -Value 1 -Type DWord -Force

        return @{ Computer = $env:COMPUTERNAME; Result = "Success" }
    }
    catch {
        return @{ Computer = $env:COMPUTERNAME; Result = "Error"; Error = $_.Exception.Message }
    }
}

Write-Host "Applying DameWare registry settings..." -ForegroundColor Cyan
Write-Host "Targets: $($ComputerNames -join ', ')" -ForegroundColor DarkCyan
Write-Host ""

$Results = @()

foreach ($Computer in $ComputerNames) {
    try {
        $Output = Invoke-Command -ComputerName $Computer -ScriptBlock $RemoteBlock -ArgumentList $RegPath -ErrorAction Stop
        $Results += $Output
    }
    catch {
        $Results += @{ Computer = $Computer; Result = "Error"; Error = $_.Exception.Message }
    }
}

# Summary
Write-Host "`n---- SUMMARY ----" -ForegroundColor Yellow

foreach ($r in $Results) {
    if ($r.Result -eq "Success") {
        Write-Host "[$($r.Computer)] OK" -ForegroundColor Green
    }
    else {
        Write-Host "[$($r.Computer)] ERROR: $($r.Error)" -ForegroundColor Red
    }
}
