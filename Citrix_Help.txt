param(
    [Parameter(Mandatory=$true)]
    [string]$ComputerName
)

Write-Host "Collecting applied Group Policies from $ComputerName..." -ForegroundColor Cyan

# Test connectivity first
if (-not (Test-Connection -ComputerName $ComputerName -Count 1 -Quiet)) {
    Write-Error "Unable to reach $ComputerName."
    exit
}

try {
    # Run gpresult remotely
    $gpResult = Invoke-Command -ComputerName $ComputerName -ScriptBlock {
        gpresult /V
    }

    # Convert output to string array
    $gpResultLines = $gpResult -split "`r?`n"

    # Function to extract applied GPOs
    function Get-AppliedGPOs {
        param([string[]]$Lines, [string]$Scope)
        $startIndex = $Lines.IndexOf($Lines | Where-Object { $_ -match "Applied Group Policy Objects for $Scope" })
        if ($startIndex -ge 0) {
            $gpoList = @()
            for ($i = $startIndex + 1; $i -lt $Lines.Count; $i++) {
                if ($Lines[$i] -match "^\s*$") { break }  # stop at blank line
                $gpoList += $Lines[$i].Trim()
            }
            return $gpoList
        } else {
            return @()
        }
    }

    $computerGPOs = Get-AppliedGPOs -Lines $gpResultLines -Scope "Computer"
    $userGPOs = Get-AppliedGPOs -Lines $gpResultLines -Scope "User"

    Write-Host "`n=== COMPUTER APPLIED GPOs ===" -ForegroundColor Yellow
    if ($computerGPOs) { $computerGPOs | ForEach-Object { Write-Host $_ } } 
    else { Write-Host "(None found)" }

    Write-Host "`n=== USER APPLIED GPOs ===" -ForegroundColor Yellow
    if ($userGPOs) { $userGPOs | ForEach-Object { Write-Host $_ } } 
    else { Write-Host "(None found)" }

} catch {
    Write-Error $_.Exception.Message
}
