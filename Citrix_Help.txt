# Set-DamewareRegistry.ps1
# Applies updated DameWare registry settings to all machines listed in machines.txt
# Now includes automatic DWMRCS service restart

# Path to the list of VMs
$ComputerListFile = ".\machines.txt"

if (!(Test-Path $ComputerListFile)) {
    Write-Host "ERROR: machines.txt not found." -ForegroundColor Red
    exit
}

# Get machine names
$ComputerNames = Get-Content $ComputerListFile | Where-Object { $_.Trim() -ne "" }

if ($ComputerNames.Count -eq 0) {
    Write-Host "ERROR: machines.txt is empty." -ForegroundColor Red
    exit
}

# Registry path
$RegPath = "HKLM:\SOFTWARE\DameWare Development\Mini Remote Control Service\Settings"

# Script executed on remote machines
$RemoteBlock = {
    param($RegPath)

    try {
        # Ensure registry path exists
        if (-not (Test-Path $RegPath)) {
            New-Item -Path $RegPath -Force | Out-Null
        }

        # Apply updated registry values
        Set-ItemProperty -Path $RegPath -Name "Notify On New Connection" -Value 0 -Type DWord -Force
        Set-ItemProperty -Path $RegPath -Name "Permission Required for non Admin Force View Only" -Value 1 -Type DWord -Force
        Set-ItemProperty -Path $RegPath -Name "Permission Required for non Admin" -Value 0 -Type DWord -Force
        Set-ItemProperty -Path $RegPath -Name "Permission Required for non Admin Disconnect If At Logon Desktop" -Value 0 -Type DWord -Force
        Set-ItemProperty -Path $RegPath -Name "Permission Required Also When Locked" -Value 0 -Type DWord -Force

        # Restart DameWare service to apply settings immediately
        try {
            Restart-Service -Name "DWMRCS" -Force -ErrorAction Stop
            $ServiceStatus = "DWMRCS service restarted"
        }
        catch {
            $ServiceStatus = "DWMRCS service restart FAILED: $($_.Exception.Message)"
        }

        return @{
            Computer = $env:COMPUTERNAME
            Result = "Success"
            Service = $ServiceStatus
        }
    }
    catch {
        return @{
            Computer = $env:COMPUTERNAME
            Result = "Error"
            Error = $_.Exception.Message
        }
    }
}

Write-Host "Applying DameWare registry settings and restarting service..." -ForegroundColor Cyan
Write-Host "Targets: $($ComputerNames -join ', ')" -ForegroundColor DarkCyan
Write-Host ""

$Results = @()

foreach ($Computer in $ComputerNames) {
    try {
        $Output = Invoke-Command -ComputerName $Computer -ScriptBlock $RemoteBlock -ArgumentList $RegPath -ErrorAction Stop
        $Results += $Output
    }
    catch {
        $Results += @{ Computer = $Computer; Result = "Error"; Error = $_.Exception.Message }
    }
}

# Summary section
Write-Host "`n---- SUMMARY ----" -ForegroundColor Yellow

foreach ($r in $Results) {
    if ($r.Result -eq "Success") {
        Write-Host "[$($r.Computer)] OK - $($r.Service)" -ForegroundColor Green
    }
    else {
        Write-Host "[$($r.Computer)] ERROR: $($r.Error)" -ForegroundColor Red
    }
}
