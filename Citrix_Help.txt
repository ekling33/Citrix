# ====================================================================
# Script: Remove-Extensions-Remote.ps1
# Purpose: Remove Microsoft Store apps remotely with DISM fallback
# ====================================================================

$MachineList = "machines.txt"
$Apps = @(
    "Microsoft.Microsoft3DViewer",
    "Microsoft.WebMediaExtensions",
    "Microsoft.VP9VideoExtensions"
)

$Timestamp = Get-Date -Format 'yyyyMMdd_HHmmss'
$LogFile   = "$env:USERPROFILE\Desktop\AppxCleanupLog_$Timestamp.txt"

$MaxRetries        = 3
$RetryDelaySeconds = 30

function Test-HostOnline {
    param([string]$ComputerName)
    Test-Connection -ComputerName $ComputerName -Count 1 -Quiet -ErrorAction SilentlyContinue
}

function Remove-AppsRemote {
    param([string]$ComputerName,[array]$Apps)

    Write-Host "`n=== Processing $ComputerName ===" -ForegroundColor Cyan
    Add-Content -Path $LogFile -Value "`n=== $ComputerName ==="

    try {
        $Script = {
            param($Apps)
            $Results = @()

            foreach ($app in $Apps) {
                try {
                    $Status = "Unknown"

                    # --- normal removal ---
                    $pkg = Get-AppxPackage -Name $app -ErrorAction SilentlyContinue
                    if ($pkg) {
                        Remove-AppxPackage -Package $pkg.PackageFullName -ErrorAction SilentlyContinue
                    }

                    $prov = Get-AppxProvisionedPackage -Online | Where-Object { $_.DisplayName -eq $app }
                    if ($prov) {
                        Remove-AppxProvisionedPackage -Online -PackageName $prov.PackageName -ErrorAction SilentlyContinue
                    }

                    # --- verify ---
                    $check = Get-AppxPackage -Name $app -ErrorAction SilentlyContinue
                    if ($check) {
                        Write-Output "[$app] Still detected, attempting DISM removal..."
                        $dismOutput  = dism /Online /Get-ProvisionedAppxPackages 2>&1
                        $packageLine = $dismOutput | Where-Object { $_ -match '^PackageName' -and $_ -match [regex]::Escape($app) }

                        if ($packageLine) {
                            $packageName = ($packageLine -replace '^PackageName\s*:\s*','').Trim()
                            Write-Output "Found package name: $packageName"
                            $dismResult = dism /Online /Remove-ProvisionedAppxPackage /PackageName:$packageName 2>&1
                            if ($LASTEXITCODE -eq 0) {
                                $Status = "SUCCESS (removed via DISM)"
                            } else {
                                $errLine = ($dismResult | Select-String -Pattern 'Error' | Select-Object -First 1).Line
                                $Status  = "FAILED after DISM ($errLine)"
                            }
                        } else {
                            $Status = "FAILED - DISM package not found"
                        }
                    } else {
                        $Status = "SUCCESS"
                    }
                } catch {
                    $Status = "ERROR - $($_.Exception.Message)"
                }
                $Results += "$app : $Status"
            }

            return $Results
        }

        Invoke-Command -ComputerName $ComputerName -ScriptBlock $Script -ArgumentList $Apps -ErrorAction Stop |
            ForEach-Object { Add-Content -Path $LogFile -Value "$ComputerName - $_" }

        Add-Content -Path $LogFile -Value "COMPLETED: $ComputerName`n"
        Write-Host "✔ $ComputerName processed successfully." -ForegroundColor Green
        return $true
    } catch {
        $err = "❌ Failed on $ComputerName - $($_.Exception.Message)"
        Write-Host $err -ForegroundColor Red
        Add-Content -Path $LogFile -Value $err
        return $false
    }
}

# --- main execution ---
if (Test-Path $MachineList) {
    $Computers = Get-Content $MachineList | Where-Object { $_ -and $_ -notmatch '^#' }

    foreach ($Computer in $Computers) {
        $Attempt = 1
        $Success = $false

        while (-not $Success -and $Attempt -le $MaxRetries) {
            Write-Host "`nAttempt $Attempt of $MaxRetries for $Computer..." -ForegroundColor Yellow

            if (-not (Test-HostOnline -ComputerName $Computer)) {
                $msg = "⚠️  $Computer is offline or unreachable (attempt $Attempt skipped)."
                Write-Host $msg -ForegroundColor DarkYellow
                Add-Content -Path $LogFile -Value $msg
                Start-Sleep -Seconds $RetryDelaySeconds
                $Attempt++
                continue
            }

            $Success = Remove-AppsRemote -ComputerName $Computer -Apps $Apps

            if (-not $Success -and $Attempt -lt $MaxRetries) {
                Write-Host "Retrying $Computer in $RetryDelaySeconds seconds..." -ForegroundColor DarkYellow
                Start-Sleep -Seconds $RetryDelaySeconds
            }

            $Attempt++
        }

        if (-not $Success) {
            $msg = "⚠️  $Computer failed after $MaxRetries attempts."
            Write-Host $msg -ForegroundColor Red
            Add-Content -Path $LogFile -Value $msg
        }
    }

    Write-Host "`n✅ All processing complete. Log saved to:`n$LogFile" -ForegroundColor Green
} else {
    Write-Error "machines.txt not found in current directory."
}
