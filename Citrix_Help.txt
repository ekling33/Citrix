# ====================================================================
# Script: Remove-Extensions-AllUsers.ps1
# Purpose: Remove 3DViewer, VP9, and WebMediaExtensions from every
#          local user profile (cleans stale user AppX registrations)
# ====================================================================

$Apps = @(
    "Microsoft.Microsoft3DViewer",
    "Microsoft.WebMediaExtensions",
    "Microsoft.VP9VideoExtensions"
)

$Timestamp = Get-Date -Format 'yyyyMMdd_HHmmss'
$LogFile   = "$env:USERPROFILE\Desktop\AppxUserCleanup_$Timestamp.txt"

Write-Host "=== Starting AppX cleanup for all local users ===" -ForegroundColor Cyan
Add-Content -Path $LogFile -Value "=== AppX Per-User Cleanup Log ($Timestamp) ===`n"

# --- Gather user profiles ---
$userProfiles = Get-CimInstance Win32_UserProfile | Where-Object {
    $_.LocalPath -like "C:\Users\*" -and
    -not ($_.LocalPath -match "Administrator|Default|Public|NetworkService|LocalService")
}

foreach ($profile in $userProfiles) {
    $userPath = $profile.LocalPath
    $sid      = $profile.SID

    Write-Host "`nProcessing user profile: $userPath" -ForegroundColor Yellow
    Add-Content -Path $LogFile -Value "`nUser: $userPath  SID: $sid"

    try {
        # Load user's registry hive if not loaded
        if (-not (Test-Path "HKU\$sid")) {
            reg load "HKU\$sid" "$userPath\NTUSER.DAT" | Out-Null
            $hiveLoaded = $true
        } else {
            $hiveLoaded = $false
        }

        # Run cleanup for this user
        $results = Invoke-Command -ScriptBlock {
            param($Apps)
            $r = @()
            foreach ($app in $Apps) {
                try {
                    $pkg = Get-AppxPackage -Name $app -ErrorAction SilentlyContinue
                    if ($pkg) {
                        Remove-AppxPackage -Package $pkg.PackageFullName -ErrorAction SilentlyContinue
                        $r += "$app : Removed"
                    } else {
                        $r += "$app : Not Found"
                    }
                } catch {
                    $r += "$app : ERROR - $($_.Exception.Message)"
                }
            }
            return $r
        } -ArgumentList ($Apps) -ErrorAction SilentlyContinue

        foreach ($line in $results) {
            Add-Content -Path $LogFile -Value "  $line"
            if ($line -match "Removed") {
                Write-Host "  $line" -ForegroundColor Green
            } else {
                Write-Host "  $line" -ForegroundColor DarkGray
            }
        }

    } catch {
        $err = "Error processing $userPath : $($_.Exception.Message)"
        Write-Host $err -ForegroundColor Red
        Add-Content -Path $LogFile -Value $err
    }
    finally {
        # Unload hive if we loaded it
        if ($hiveLoaded) {
            reg unload "HKU\$sid" | Out-Null
        }
    }
}

# --- Verification ---
Write-Host "`n=== Verification Pass ===" -ForegroundColor Cyan
Add-Content -Path $LogFile -Value "`n=== Verification ==="

foreach ($app in $Apps) {
    $userPkg = Get-AppxPackage -AllUsers -Name $app -ErrorAction SilentlyContinue
    if ($userPkg) {
        $msg = "⚠️  $app : Still detected for some users"
        Write-Host $msg -ForegroundColor Yellow
    } else {
        $msg = "✅ $app : Fully removed from all profiles"
        Write-Host $msg -ForegroundColor Green
    }
    Add-Content -Path $LogFile -Value $msg
}

Write-Host "`n=== Completed. Log saved to: $LogFile ===" -ForegroundColor Cyan
