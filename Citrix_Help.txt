<#
.SYNOPSIS
Remotely forces Google Chrome and Microsoft Edge updates on Windows 10 VMs.

.DESCRIPTION
Reads machine names from machines.txt, connects via PowerShell remoting or WMI,
and triggers GoogleUpdate and EdgeUpdate executables if found.
Requires admin privileges and PowerShell remoting enabled on targets.
#>

# --- CONFIGURATION ---
$MachineList = Get-Content ".\machines.txt"
$LogFile = ".\BrowserUpdateLog_{0}.log" -f (Get-Date -Format "yyyyMMdd_HHmmss")

# --- FUNCTIONS ---
function Write-Log {
    param($Message)
    $Timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $Entry = "$Timestamp `t $Message"
    Write-Host $Entry
    Add-Content -Path $LogFile -Value $Entry
}

function Invoke-RemoteUpdate {
    param([string]$ComputerName)

    Write-Log "==== $ComputerName ===="

    # Test basic network connectivity
    if (-not (Test-Connection -ComputerName $ComputerName -Count 1 -Quiet)) {
        Write-Log "[$ComputerName] Unreachable."
        return
    }

    try {
        # Force Group Policy update
        Invoke-GPUpdate -Computer $ComputerName -RandomDelayInMinutes 0 -Force -ErrorAction Stop
        Write-Log "[$ComputerName] Group Policy refreshed."

        # Trigger Google Chrome update
        $chromeUpdateCmd = "C:\Program Files (x86)\Google\Update\GoogleUpdate.exe"
        $edgeUpdateCmd   = "C:\Program Files (x86)\Microsoft\EdgeUpdate\MicrosoftEdgeUpdate.exe"

        Invoke-Command -ComputerName $ComputerName -ScriptBlock {
            $chromeUpdate = "C:\Program Files (x86)\Google\Update\GoogleUpdate.exe"
            $edgeUpdate   = "C:\Program Files (x86)\Microsoft\EdgeUpdate\MicrosoftEdgeUpdate.exe"

            if (Test-Path $chromeUpdate) {
                Start-Process -FilePath $chromeUpdate -ArgumentList "/ua /installsource scheduler" -Wait
            }

            if (Test-Path $edgeUpdate) {
                Start-Process -FilePath $edgeUpdate -ArgumentList "/update MicrosoftEdge" -Wait
            }

            # Get current versions
            $chromeVer = (Get-Item "C:\Program Files\Google\Chrome\Application\chrome.exe" -ErrorAction SilentlyContinue).VersionInfo.ProductVersion
            $edgeVer   = (Get-Item "C:\Program Files (x86)\Microsoft\Edge\Application\msedge.exe" -ErrorAction SilentlyContinue).VersionInfo.ProductVersion

            [PSCustomObject]@{
                ChromeVersion = $chromeVer
                EdgeVersion   = $edgeVer
            }
        } -ErrorAction Stop | ForEach-Object {
            Write-Log "[$ComputerName] Chrome: $($_.ChromeVersion) | Edge: $($_.EdgeVersion)"
        }

    } catch {
        Write-Log "[$ComputerName] ERROR: $($_.Exception.Message)"
    }
}

# --- MAIN LOOP ---
Write-Log "Starting browser update run on $(($MachineList).Count) machines..."
foreach ($Machine in $MachineList) {
    Invoke-RemoteUpdate -ComputerName $Machine.Trim()
}
Write-Log "Update process complete."
